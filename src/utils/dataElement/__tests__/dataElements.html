<html>
  <head>
    <script>
      var actionDelegateSpy = jasmine.createSpy();

      var container = {
        extensions: {
          testExtension: {
            name: "Test Extension"
          },
          actions: {
            testAction: function(module) {
              module.exports = actionDelegateSpy;
            }
          },
          events: {
            testEvent: function(module, require) {
              var allTriggers = [];

              window.triggerTestEvent = function() {
                allTriggers.forEach(function(trigger) {
                  var targetElement = document.createElement('div');
                  targetElement.id = 'fruitPartyBowl';

                  var pseudoEvent = {
                    type: 'fruitParty',
                    target: targetElement,
                    fruit: 'apple'
                  };

                  var relatedElement = document.createElement('span');
                  relatedElement.id = 'kazoo';
                  relatedElement.innerHTML = '  <a href="#">Content with line \n breaks and multiple   spaces</a>';

                  trigger(pseudoEvent, relatedElement);
                });
              };

              module.exports = function(config, trigger) {
                allTriggers.push(trigger);
              };
            }
          },
          dataElements: {
            'testExtension.static': function(module, require) {
              module.exports = function(config) {
                return config.staticValue;
              };
            }
          }
        },
        rules: [
          {
            events: [{
              type: 'testEvent',
              config: {
                name: 'foo'
              }
            }],
            actions: [
              {
                type: 'testAction',
                config: {
                  dataElementBased: '%treat%',
                  dataElementPriorityBased: '%vegetable%',
                  dataElementDefaultBased: '%meat%',
                  dataElementIntegerBased: '%bottlesofbeeronthewall%',
                  dataElementPageViewBased: '%beverage:pageview%',
                  dataElementVisitorBased: '%beverage:visitor%',
                  dataElementSessionBased: '%beverage:session%',
                  URIBased: '%URI%',
                  uriBased: '%uri%',
                  protocolBased: '%protocol%',
                  hostnameBased: '%hostname%',
                  thisBased: '%this.id%',
                  thisTextBased: '%this.@text%',
                  thisCleanTextBased: '%this.@cleanText%',
                  eventBased: '%event.fruit%',
                  targetBased: '%target.id%',
                  windowBased: '%window.my.nested.thing%',
                  paramBased: '%param.fooParam%',
                  randBased: '%rand3%',
                  customBased: '%instrument%',
                  undefinedBased: '%notdefined%'
                }
              }
            ]
          }
        ],
        dataElements: {
          'treat': {
            type: "testExtension.static",
            config: {
              staticValue: "Ice   \n Cream  \n  ",
              forceLowerCase: true,
              cleanText: true
            }
          },
          'vegetable': {
            type: "testExtension.static",
            config: {
              staticValue: "carrot"
            }
          },
          'meat': {
            type: "testExtension.static",
            config: {
              default: "default meat"
            }
          },
          'bottlesofbeeronthewall': {
            type: 'testExtension.static',
            config: {
              staticValue: 99,
              forceLowerCase: true
            }
          },
          'beverage:pageview': {
            type: "testExtension.static",
            config: {
              staticValue: 'Piña Colada',
              storeLength: 'pageview'
            }
          },
          'beverage:visitor': {
            type: "testExtension.static",
            config: {
              staticValue: 'Soda',
              storeLength: 'visitor'
            }
          },
          'beverage:session': {
            type: "testExtension.static",
            config: {
              staticValue: 'Fruit Punch',
              storeLength: 'session'
            }
          }
        },
        config: {
          undefinedVarsReturnEmpty: true
        }
      };

      _satellite = {
        container: container
      };
    </script>
    <script src="/base/testrunner/engine.js"></script>
    <script>
      TestPage
        .execute(function() {
          window.my = {
            nested: {
              thing: 'applejacks'
            }
          };

          _satellite.setVar('instrument', 'piccolo');
          _satellite.setVar('vegetable', 'onion');

          window.triggerTestEvent();

          expect(actionDelegateSpy.calls.count()).toBe(1);
          var actionConfig = actionDelegateSpy.calls.argsFor(0)[0];
          expect(actionConfig.dataElementBased).toBe('ice cream');
          // Both a data element and a custom variable (set using setVar) named "vegetable" have
          // been set. The data element has a higher priority.
          expect(actionConfig.dataElementPriorityBased).toBe('carrot');
          expect(actionConfig.dataElementDefaultBased).toBe('default meat');
          expect(actionConfig.dataElementIntegerBased).toBe('99');
          expect(actionConfig.dataElementPageViewBased).toBe('Piña Colada');
          expect(document.cookie.indexOf('_sdsat_beverage:pageview=Piña Colada')).toBe(-1);
          expect(actionConfig.dataElementVisitorBased).toBe('Soda');
          expect(document.cookie.indexOf('_sdsat_beverage:visitor=Soda') > -1).toBe(true);
          expect(actionConfig.dataElementSessionBased).toBe('Fruit Punch');
          expect(document.cookie.indexOf('_sdsat_beverage:session=Fruit Punch') > -1).toBe(true);
          expect(actionConfig.URIBased).toBe(document.location.pathname + document.location.search);
          expect(actionConfig.uriBased).toBe(document.location.pathname + document.location.search);
          expect(actionConfig.protocolBased).toBe(window.location.protocol);
          expect(actionConfig.hostnameBased).toBe(document.location.hostname);
          expect(actionConfig.thisBased).toBe('kazoo');
          expect(actionConfig.thisTextBased).toBe('  Content with line \n breaks and multiple   spaces');
          expect(actionConfig.thisCleanTextBased).toBe('Content with line breaks and multiple spaces');
          expect(actionConfig.eventBased).toBe('apple');
          expect(actionConfig.targetBased).toBe('fruitPartyBowl');
          expect(actionConfig.windowBased).toBe('applejacks');
          expect(actionConfig.paramBased).toBe('barValue');
          expect(typeof actionConfig.randBased).toBe('string');
          expect(actionConfig.randBased.length).toBe(3);
          expect(actionConfig.customBased).toBe('piccolo');
          // undefinedVarsReturnEmpty=true on property config so it returns an empty string
          expect(actionConfig.undefinedBased).toBe('');
          expect(_satellite.getVar('instrument')).toBe('piccolo');
          expect(_satellite.getVar('bottlesofbeeronthewall')).toBe(99);
          // Note that even though "onion" was set through setVar() the configured data element
          // still takes precedence.
          expect(_satellite.getVar('vegetable')).toBe('carrot');
          // When undefinedVarsReturnEmpty is true on property config, getVar() still returns
          // undefined. It only returns an empty string when using a %% token for some reason.
          expect(_satellite.getVar('undefinedBased')).toBe(undefined);
        })
        .start();
    </script>
  </head>
  <body>
    <script>
      _satellite.pageBottom();
    </script>
  </body>
</html>
