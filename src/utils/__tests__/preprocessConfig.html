<html>
  <head>
    <script>
      var eventDelegateSpy = jasmine.createSpy();
      var conditionDelegateSpy = jasmine.createSpy();
      var actionDelegateSpy = jasmine.createSpy();
      var eventRequiredExtensionConfig;
      var conditionRequiredExtensionConfig;
      var actionRequiredExtensionConfig;

      // This text is appended onto data element values. This can be changed to determine
      // whether a configuration object is preprocessed each time rather than being saved to
      // some sort of cache.
      var dataElementAppendText = ':first';

      var unprocessedConfig = {
        accountId: '%account%',
        nestedObjectCheck: {
          firstName: '%firstName%',
          lastName: '%lastName%',
          arrayCheck: ['%firstName%', '%lastName%'],
          nestedArrayCheck: [
            ['%apple%', '%pear%']
          ],
          regexCheck: /test/i
        }
      };

      var unprocessedConfigWithElementAndEvent = {
        accountId: '%account%',
        nestedObjectCheck: {
          firstName: '%firstName%',
          lastName: '%lastName%',
          arrayCheck: ['%firstName%', '%lastName%'],
          nestedArrayCheck: [
            ['%apple%', '%pear%']
          ],
          regexCheck: /test/i
        },
        elementCheck: '%this.id%',
        eventCheck: '%event.fruit%'
      };

      var container = {
        extensions: {
          testExtension: {
            configs: {
              abc: unprocessedConfig
            },
            events: {
              testEvent: function(module, require) {
                var extensionConfigProvider = require('extensionConfigProvider');
                console.log('asdfasdf', extensionConfigProvider);

                var allTriggers = [];

                window.triggerTestEvent = function() {
                  allTriggers.forEach(function(trigger) {
                    var pseudoEvent = {
                      type: 'fruitParty',
                      target: document.createElement('div'),
                      fruit: 'apple'
                    };

                    var relatedElement = document.createElement('span');
                    relatedElement.id = 'kazoo';

                    trigger(pseudoEvent, relatedElement);
                  });
                };

                module.exports = eventDelegateSpy.and.callFake(function(config, trigger) {
                  eventRequiredExtensionConfig = extensionConfigProvider.getById('abc');
                  allTriggers.push(trigger);
                });
              }
            },
            conditions: {
              testCondition: function(module, require) {
                var extensionConfigProvider = require('extensionConfigProvider');

                module.exports = conditionDelegateSpy.and.callFake(function() {
                  conditionRequiredExtensionConfig = extensionConfigProvider.getById('abc');
                  return true;
                });
              }
            },
            actions: {
              testAction: function(module, require) {
                var extensionConfigProvider = require('extensionConfigProvider');

                module.exports = actionDelegateSpy.and.callFake(function() {
                  actionRequiredExtensionConfig = extensionConfigProvider.getById('abc');
                });
              }
            },
            dataElements: {
              'testExtension.appendText': function(module) {
                module.exports = function(config) {
                  // Append some text. This allows us to change the text that is appended in order to
                  // test that configurations are processed each time a condition or action is called.
                  return config.value + dataElementAppendText;
                };
              }
            }
          }
        },
        rules: [
          {
            events: [
              {
                type: 'testEvent',
                config: unprocessedConfig
              }
            ],
            conditions: [
              {
                type: 'testCondition',
                // Only conditions and actions can use %this.something% and %event.something%
                config: unprocessedConfigWithElementAndEvent
              }
            ],
            actions: [
              {
                type: 'testAction',
                // Only conditions and actions can use %this.something% and %event.something%
                config: unprocessedConfigWithElementAndEvent
              }
            ]
          }
        ],
        dataElements: {
          account: {
            type: "testExtension.appendText",
            config: {
              value: "ABC123"
            }
          },
          firstName: {
            type: "testExtension.appendText",
            config: {
              value: "John"
            }
          },
          lastName: {
            type: "testExtension.appendText",
            config: {
              value: "Doe"
            }
          },
          apple: {
            type: "testExtension.appendText",
            config: {
              value: "apple"
            }
          },
          pear: {
            type: "testExtension.appendText",
            config: {
              value: "pear"
            }
          }
        }
      };

      _satellite = {
        container: container
      };
    </script>
    <script src="/base/testrunner/engine.js"></script>
    <script>
      TestPage
        .execute(function() {
          // We're not testing all the various forms of data elements here. Those tests are in
          // the data element tests. These tests are only to ensure that the configuration objects
          // are being run through preprocessing at the right times, that preprocessing
          // deeply preprocesses the configuration object, and that an element and event are
          // included in preprocessing for conditions and actions.

          window.triggerTestEvent();

          var firstProcessedConfig = {
            accountId: 'ABC123:first',
            nestedObjectCheck: {
              firstName: 'John:first',
              lastName: 'Doe:first',
              arrayCheck: ['John:first', 'Doe:first'],
              nestedArrayCheck: [
                ['apple:first', 'pear:first']
              ],
              regexCheck: /test/i
            }
          };

          // Only conditions and actions can use %this.something% and %event.something%
          var firstProcessedConfigWithElementAndEvent = {
            accountId: 'ABC123:first',
            nestedObjectCheck: {
              firstName: 'John:first',
              lastName: 'Doe:first',
              arrayCheck: ['John:first', 'Doe:first'],
              nestedArrayCheck: [
                ['apple:first', 'pear:first']
              ],
              regexCheck: /test/i
            },
            elementCheck: 'kazoo',
            eventCheck: 'apple'
          };

          expect(eventDelegateSpy.calls.argsFor(0)[0])
              .toEqual(firstProcessedConfig);
          expect(eventRequiredExtensionConfig).toEqual(firstProcessedConfig);

          expect(conditionDelegateSpy.calls.argsFor(0)[0])
              .toEqual(firstProcessedConfigWithElementAndEvent);
          expect(conditionRequiredExtensionConfig).toEqual(firstProcessedConfig);

          expect(actionDelegateSpy.calls.argsFor(0)[0])
              .toEqual(firstProcessedConfigWithElementAndEvent);
          expect(actionRequiredExtensionConfig).toEqual(firstProcessedConfig);

          // Test that configurations are being preprocessed each time a condition or action is
          // called and not just the first time.

          var secondProcessedConfig = {
            accountId: 'ABC123:second',
            nestedObjectCheck: {
              firstName: 'John:second',
              lastName: 'Doe:second',
              arrayCheck: ['John:second', 'Doe:second'],
              nestedArrayCheck: [
                ['apple:second', 'pear:second']
              ],
              regexCheck: /test/i
            }
          };

          // Only conditions and actions can use %this.something% and %event.something%
          var secondProcessedConfigWithElementAndEvent = {
            accountId: 'ABC123:second',
            nestedObjectCheck: {
              firstName: 'John:second',
              lastName: 'Doe:second',
              arrayCheck: ['John:second', 'Doe:second'],
              nestedArrayCheck: [
                ['apple:second', 'pear:second']
              ],
              regexCheck: /test/i
            },
            elementCheck: 'kazoo',
            eventCheck: 'apple'
          };

          dataElementAppendText = ':second';
          window.triggerTestEvent();

          expect(conditionDelegateSpy.calls.argsFor(1)[0])
              .toEqual(secondProcessedConfigWithElementAndEvent);
          expect(conditionRequiredExtensionConfig).toEqual(secondProcessedConfig);
          // Right now the property config isn't reprocessed each time it's required.

          expect(actionDelegateSpy.calls.argsFor(1)[0])
              .toEqual(secondProcessedConfigWithElementAndEvent);
          expect(actionRequiredExtensionConfig).toEqual(secondProcessedConfig);
          // Right now the property config isn't reprocessed each time it's required.
        })
        .start();
    </script>
  </head>
  <body>
    <script>
      _satellite.pageBottom();
    </script>
  </body>
</html>
