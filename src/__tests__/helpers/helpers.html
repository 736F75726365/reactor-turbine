<html>
  <head>
    <script>
      var testHelperExports = {};
      var receivedHelperExports;
      var neverRequiredHelperSpy = jasmine.createSpy();

      _satellite = {};

      _satellite.container = {
        extensions: {
          EXa: {
            displayName: 'Example Extension A',
            name: 'example-extension-a',
            delegates: {
              'example-extension-a/events/test-event': {
                displayName: 'Test Event',
                script: function(module) {
                  var allTriggers = [];

                  window.triggerTestEvent = function() {
                    allTriggers.forEach(function(trigger) {
                      trigger();
                    });
                  };

                  module.exports = function(config, trigger) {
                    allTriggers.push(trigger);
                  };
                }
              },
              'example-extension-a/actions/test-action': {
                displayName: 'Test Action',
                script: function(module, require) {
                  var getExtension = require('get-extension');
                  var extension = getExtension('example-extension-a');
                  receivedHelperExports = extension.getHelper('test-helper');
                  module.exports = function() {};
                }
              }
            },
            helpers: {
              'example-extension-a/helpers/test-helper': {
                script: function(module) {
                  module.exports = testHelperExports;
                }
              }
            }
          },
          EXb: {
            displayName: 'Example Extension B',
            name: 'example-extension-b',
            helpers: {
              'example-extension-b/helpers/never-required': {
                script: neverRequiredHelperSpy.and.callFake(function(module) {
                  module.exports = {};
                })
              }
            }
          }
        },
        rules: [
          {
            events: [
              {
                delegateId: 'example-extension-a/events/test-event'
              }
            ],
            actions: [
              {
                delegateId: 'example-extension-a/actions/test-action'
              }
            ]
          }
        ]
      };
    </script>
    <script src="/base/testrunner/engine.js"></script>
  </head>
  <body>
    <script>
      _satellite.pageBottom();

      TestPage.execute(function() {
        window.triggerTestEvent();
        expect(receivedHelperExports).toBe(testHelperExports);

        // The module should be called for even when it isn't required by anything. This is so
        // extensions can have logic that runs even when there are no event, condition, action,
        // or data element types configured.
        expect(neverRequiredHelperSpy.calls.count()).toBe(1);
      }).start();
    </script>
  </body>
</html>
