<html>
  <head>
    <script>
      var eventDelegateSpy = jasmine.createSpy();
      var conditionDelegateSpy = jasmine.createSpy();
      var actionDelegateSpy = jasmine.createSpy();
      var eventRequiredIntegration;
      var conditionRequiredIntegration;
      var actionRequiredIntegration;
      var eventRequiredProperty;
      var conditionRequiredProperty;
      var actionRequiredProperty;

      // This text is appended onto data element values. This can be changed to determine
      // whether a configuration object is preprocessed each time rather than being saved to
      // some sort of cache.
      var dataElementAppendText = ':first';

      var unprocessedConfig = {
        accountId: '%account%',
        nestedObjectCheck: {
          firstName: '%firstName%',
          lastName: '%lastName%',
          arrayCheck: ['%firstName%', '%lastName%'],
        }
      };

      var unprocessedConfigWithElementAndEvent = {
        accountId: '%account%',
        nestedObjectCheck: {
          firstName: '%firstName%',
          lastName: '%lastName%',
          arrayCheck: ['%firstName%', '%lastName%'],
        },
        elementCheck: '%this.id%',
        eventCheck: '%event.fruit%'
      };

      var container = {
        extensions: {
          testExtension: {
            name: "Test Extension"
          }
        },
        integrations: {
          'abc': {
            extensionId: 'testExtension',
            config: unprocessedConfig
          }
        },
        eventDelegates: {
          testEvent: function(module, require) {
            var integrations = require('integrations');
            eventRequiredProperty = require('property');

            var allTriggers = [];

            window.triggerTestEvent = function() {
              allTriggers.forEach(function(trigger) {
                var pseudoEvent = {
                  type: 'fruitParty',
                  target: document.createElement('div'),
                  fruit: 'apple'
                };

                var relatedElement = document.createElement('span');
                relatedElement.id = 'kazoo';

                trigger(pseudoEvent, relatedElement);
              });
            };

            module.exports = eventDelegateSpy.and.callFake(function(config, trigger) {
              eventRequiredIntegration = integrations.getById('abc');
              allTriggers.push(trigger);
            });
          }
        },
        conditionDelegates: {
          testCondition: function(module, require) {
            var integrations = require('integrations');
            conditionRequiredProperty = require('property');

            module.exports = conditionDelegateSpy.and.callFake(function() {
              conditionRequiredIntegration = integrations.getById('abc');
              return true;
            });
          }
        },
        actionDelegates: {
          testAction: function(module, require) {
            var integrations = require('integrations');
            actionRequiredProperty = require('property');

            module.exports = actionDelegateSpy.and.callFake(function() {
              actionRequiredIntegration = integrations.getById('abc');
            });
          }
        },
        rules: [
          {
            events: [
              {
                type: 'testEvent',
                config: unprocessedConfig
              }
            ],
            conditions: [
              {
                type: 'testCondition',
                // Only conditions and actions can use %this.something% and %event.something%
                config: unprocessedConfigWithElementAndEvent
              }
            ],
            actions: [
              {
                type: 'testAction',
                // Only conditions and actions can use %this.something% and %event.something%
                config: unprocessedConfigWithElementAndEvent
              }
            ]
          }
        ],
        dataElementDelegates: {
          'testExtension.appendText': function(module) {
            module.exports = function(config) {
              // Append some text. This allows us to change the text that is appended in order to
              // test that configurations are processed each time a condition or action is called.
              return config.value + dataElementAppendText;
            };
          }
        },
        dataElements: {
          account: {
            type: "testExtension.appendText",
            config: {
              value: "ABC123"
            }
          },
          firstName: {
            type: "testExtension.appendText",
            config: {
              value: "John"
            }
          },
          lastName: {
            type: "testExtension.appendText",
            config: {
              value: "Doe"
            }
          }
        },
        config: unprocessedConfig
      };

      _satellite = {
        container: container
      };
    </script>
    <script src="/base/dist/engine.js"></script>
    <script src="/base/src/__tests__/helpers/testpage.js"></script>
    <script>
      TestPage
        .execute(function() {
          // We're not testing all the various forms of data elements here. Those tests are in
          // the data element tests. These tests are only to ensure that the configuration objects
          // are being run through preprocessing at the right times, that preprocessing
          // deeply preprocesses the configuration object, and that an element and event are
          // included in preprocessing for conditions and actions.

          window.triggerTestEvent();

          var firstProcessedConfig = {
            accountId: 'ABC123:first',
            nestedObjectCheck: {
              firstName: 'John:first',
              lastName: 'Doe:first',
              arrayCheck: ['John:first', 'Doe:first']
            }
          };

          // Only conditions and actions can use %this.something% and %event.something%
          var firstProcessedConfigWithElementAndEvent = {
            accountId: 'ABC123:first',
            nestedObjectCheck: {
              firstName: 'John:first',
              lastName: 'Doe:first',
              arrayCheck: ['John:first', 'Doe:first']
            },
            elementCheck: 'kazoo',
            eventCheck: 'apple'
          };

          expect(eventDelegateSpy.calls.argsFor(0)[0])
              .toEqual(firstProcessedConfig);
          expect(eventRequiredIntegration).toEqual(firstProcessedConfig);
          expect(eventRequiredProperty).toEqual(firstProcessedConfig);

          expect(conditionDelegateSpy.calls.argsFor(0)[0])
              .toEqual(firstProcessedConfigWithElementAndEvent);
          expect(conditionRequiredIntegration).toEqual(firstProcessedConfig);
          expect(conditionRequiredProperty).toEqual(firstProcessedConfig);

          expect(actionDelegateSpy.calls.argsFor(0)[0])
              .toEqual(firstProcessedConfigWithElementAndEvent);
          expect(actionRequiredIntegration).toEqual(firstProcessedConfig);
          expect(actionRequiredProperty).toEqual(firstProcessedConfig);

          // Test that configurations are being preprocessed each time a condition or action is
          // called and not just the first time.

          var secondProcessedConfig = {
            accountId: 'ABC123:second',
            nestedObjectCheck: {
              firstName: 'John:second',
              lastName: 'Doe:second',
              arrayCheck: ['John:second', 'Doe:second']
            }
          };

          // Only conditions and actions can use %this.something% and %event.something%
          var secondProcessedConfigWithElementAndEvent = {
            accountId: 'ABC123:second',
            nestedObjectCheck: {
              firstName: 'John:second',
              lastName: 'Doe:second',
              arrayCheck: ['John:second', 'Doe:second']
            },
            elementCheck: 'kazoo',
            eventCheck: 'apple'
          };

          dataElementAppendText = ':second';
          window.triggerTestEvent();

          expect(conditionDelegateSpy.calls.argsFor(1)[0])
              .toEqual(secondProcessedConfigWithElementAndEvent);
          expect(conditionRequiredIntegration).toEqual(secondProcessedConfig);
          // Right now the property config isn't reprocessed each time it's required.
          expect(conditionRequiredProperty).toEqual(firstProcessedConfig);

          expect(actionDelegateSpy.calls.argsFor(1)[0])
              .toEqual(secondProcessedConfigWithElementAndEvent);
          expect(actionRequiredIntegration).toEqual(secondProcessedConfig);
          // Right now the property config isn't reprocessed each time it's required.
          expect(actionRequiredProperty).toEqual(firstProcessedConfig);
        })
        .start();
    </script>
  </head>
  <body>
    <script>
      _satellite.pageBottom();
    </script>
  </body>
</html>
