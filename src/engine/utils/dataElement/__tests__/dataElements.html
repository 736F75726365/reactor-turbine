<html>
  <head>
    <script src="/base/dist/config.js"></script>
    <script>
      jasmine.clock().install();

      var config = _satellite.getConfig();
      var actionSpy = jasmine.createSpy();

      config.integrations = {
        'abc': {
          type: 'testExtension',
          settings: {
            mmmtreats: '%treat%',
            accountId: 123
          }
        }
      };

      var coreDelegateSpy = jasmine.createSpy().and.callFake(function() {
        return {
          test: actionSpy
        };
      });

      config.coreDelegates = {
        testExtension: function(module, require) {
          module.exports = coreDelegateSpy
        }
      };

      config.eventDelegates = {
        testEvent: function(module, require) {
          var allTriggers = [];

          _satellite.triggerTestEvent = function() {
            allTriggers.forEach(function(trigger) {
              var targetElement = document.createElement('div');
              targetElement.id = 'fruitPartyBowl';

              var pseudoEvent = {
                type: 'fruitParty',
                target: targetElement,
                fruit: 'apple'
              };

              var relatedElement = document.createElement('span');
              relatedElement.id = 'kazoo';
              relatedElement.innerHTML = '  <a href="#">Content with line \n breaks and multiple   spaces</a>';

              trigger(pseudoEvent, relatedElement);
            });
          };

          module.exports = function(trigger, settings) {
            allTriggers.push(trigger);
          };
        }
      };

      config.rules = [
        {
          events: [{
            type: 'testEvent',
            settings: {
              name: 'foo'
            }
          }],
          actions: [
            {
              integrationIds: ['abc'],
              method: 'test',
              settings: {
                dataElementBased: '%treat%',
                dataElementPriorityBased: '%vegetable%',
                dataElementDefaultBased: '%meat%',
                dataElementIntegerBased: '%bottlesofbeeronthewall%',
                dataElementPageViewBased: '%beverage:pageview%',
                dataElementVisitorBased: '%beverage:visitor%',
                dataElementSessionBased: '%beverage:session%',
                URIBased: '%URI%',
                uriBased: '%uri%',
                protocolBased: '%protocol%',
                hostnameBased: '%hostname%',
                thisBased: '%this.id%',
                thisTextBased: '%this.@text%',
                thisCleanTextBased: '%this.@cleanText%',
                eventBased: '%event.fruit%',
                targetBased: '%target.id%',
                windowBased: '%window.my.nested.thing%',
                paramBased: '%param.fooParam%',
                randBased: '%rand3%',
                customBased: '%instrument%',
                undefinedBased: '%notdefined%',
              }
            }
          ]
        }
      ];

      config.dataElementDelegates = {
        'testExtension.static': function(module, require) {
          module.exports = function(settings) {
            return settings.staticValue;
          };
        }
      };

      config.dataElements = [
        {
          name: "treat",
          type: "testExtension.static",
          settings: {
            staticValue: "Ice   \n Cream  \n  ",
            forceLowerCase: true,
            cleanText: true
          }
        },
        {
          name: "vegetable",
          type: "testExtension.static",
          settings: {
            staticValue: "carrot"
          }
        },
        {
          name: "meat",
          type: "testExtension.static",
          settings: {
            default: "default meat"
          }
        },
        {
          name: 'bottlesofbeeronthewall',
          type: 'testExtension.static',
          settings: {
            staticValue: 99,
            forceLowerCase: true
          }
        },
        {
          name: "beverage:pageview",
          type: "testExtension.static",
          settings: {
            staticValue: 'Piña Colada',
            storeLength: 'pageview'
          }
        },
        {
          name: "beverage:visitor",
          type: "testExtension.static",
          settings: {
            staticValue: 'Soda',
            storeLength: 'visitor'
          }
        },
        {
          name: "beverage:session",
          type: "testExtension.static",
          settings: {
            staticValue: 'Fruit Punch',
            storeLength: 'session'
          }
        }
      ];

      config.settings.undefinedVarsReturnEmpty = true;
    </script>
    <script src="/base/dist/engine.js"></script>
    <script src="/base/src/__tests__/helpers/testpage.js"></script>
    <script>
      TestPage
        .execute(function() {
          window.my = {
            nested: {
              thing: 'applejacks'
            }
          };

          _satellite.setVar('instrument', 'piccolo');
          _satellite.setVar('vegetable', 'onion');

          expect(coreDelegateSpy.calls.argsFor(0)).toEqual([
            {
              mmmtreats: 'ice cream',
              accountId: 123
            }
          ]);

          _satellite.triggerTestEvent();

          // Actions are always run asynchronously.
          jasmine.clock().tick(1);

          expect(actionSpy.calls.count()).toBe(1);
          var actionSettings = actionSpy.calls.argsFor(0)[0];
          expect(actionSettings.dataElementBased).toBe('ice cream');
          // Both a data element and a custom variable (set using setVar) named "vegetable" have
          // been set. The data element has a higher priority.
          expect(actionSettings.dataElementPriorityBased).toBe('carrot');
          expect(actionSettings.dataElementDefaultBased).toBe('default meat');
          expect(actionSettings.dataElementIntegerBased).toBe('99');
          expect(actionSettings.dataElementPageViewBased).toBe('Piña Colada');
          expect(document.cookie.indexOf('_sdsat_beverage:pageview=Piña Colada')).toBe(-1);
          expect(actionSettings.dataElementVisitorBased).toBe('Soda');
          expect(document.cookie.indexOf('_sdsat_beverage:visitor=Soda') > -1).toBe(true);
          expect(actionSettings.dataElementSessionBased).toBe('Fruit Punch');
          expect(document.cookie.indexOf('_sdsat_beverage:session=Fruit Punch') > -1).toBe(true);
          expect(actionSettings.URIBased).toBe(document.location.pathname + document.location.search);
          expect(actionSettings.uriBased).toBe(document.location.pathname + document.location.search);
          expect(actionSettings.protocolBased).toBe(window.location.protocol);
          expect(actionSettings.hostnameBased).toBe(document.location.hostname);
          expect(actionSettings.thisBased).toBe('kazoo');
          expect(actionSettings.thisTextBased).toBe('  Content with line \n breaks and multiple   spaces');
          expect(actionSettings.thisCleanTextBased).toBe('Content with line breaks and multiple spaces');
          expect(actionSettings.eventBased).toBe('apple');
          expect(actionSettings.targetBased).toBe('fruitPartyBowl');
          expect(actionSettings.windowBased).toBe('applejacks');
          expect(actionSettings.paramBased).toBe('barValue');
          expect(typeof actionSettings.randBased).toBe('string');
          expect(actionSettings.randBased.length).toBe(3);
          expect(actionSettings.customBased).toBe('piccolo');
          // undefinedVarsReturnEmpty=true on property settings so it returns an empty string
          expect(actionSettings.undefinedBased).toBe('');
          expect(_satellite.getVar('instrument')).toBe('piccolo');
          expect(_satellite.getVar('bottlesofbeeronthewall')).toBe(99);
          // Note that even though "onion" was set through setVar() the configured data element
          // still takes precedence.
          expect(_satellite.getVar('vegetable')).toBe('carrot');
          // When undefinedVarsReturnEmpty is true on property settings, getVar() still returns
          // undefined. It only returns an empty string when using a %% token for some reason.
          expect(_satellite.getVar('undefinedBased')).toBe(undefined);
        })
        .start();
    </script>
  </head>
  <body>
    <script>
      _satellite.pageBottom();
    </script>
  </body>
</html>
