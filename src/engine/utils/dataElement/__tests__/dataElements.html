<html>
  <head>
    <script>
      jasmine.clock().install();

      var coreDelegateSpy = jasmine.createSpy();
      var actionDelegateSpy = jasmine.createSpy();

      var container = {
        extensions: {
          testExtension: {
            name: "Test Extension"
          }
        },
        integrations: {
          'abc': {
            type: 'testExtension',
            config: {
              mmmtreats: '%treat%',
              accountId: 123
            }
          }
        },
        coreDelegates: {
          testExtension: function(module, require) {
            module.exports = coreDelegateSpy;
          }
        },
        actionDelegates: {
          test: function(module) {
            module.exports = actionDelegateSpy;
          }
        },
        eventDelegates: {
          testEvent: function(module, require) {
            var allTriggers = [];

            _satellite.triggerTestEvent = function() {
              allTriggers.forEach(function(trigger) {
                var targetElement = document.createElement('div');
                targetElement.id = 'fruitPartyBowl';

                var pseudoEvent = {
                  type: 'fruitParty',
                  target: targetElement,
                  fruit: 'apple'
                };

                var relatedElement = document.createElement('span');
                relatedElement.id = 'kazoo';
                relatedElement.innerHTML = '  <a href="#">Content with line \n breaks and multiple   spaces</a>';

                trigger(pseudoEvent, relatedElement);
              });
            };

            module.exports = function(config, trigger) {
              allTriggers.push(trigger);
            };
          }
        },
        rules: [
          {
            events: [{
              type: 'testEvent',
              config: {
                name: 'foo'
              }
            }],
            actions: [
              {
                integrationIds: ['abc'],
                type: 'test',
                config: {
                  dataElementBased: '%treat%',
                  dataElementPriorityBased: '%vegetable%',
                  dataElementDefaultBased: '%meat%',
                  dataElementIntegerBased: '%bottlesofbeeronthewall%',
                  dataElementPageViewBased: '%beverage:pageview%',
                  dataElementVisitorBased: '%beverage:visitor%',
                  dataElementSessionBased: '%beverage:session%',
                  URIBased: '%URI%',
                  uriBased: '%uri%',
                  protocolBased: '%protocol%',
                  hostnameBased: '%hostname%',
                  thisBased: '%this.id%',
                  thisTextBased: '%this.@text%',
                  thisCleanTextBased: '%this.@cleanText%',
                  eventBased: '%event.fruit%',
                  targetBased: '%target.id%',
                  windowBased: '%window.my.nested.thing%',
                  paramBased: '%param.fooParam%',
                  randBased: '%rand3%',
                  customBased: '%instrument%',
                  undefinedBased: '%notdefined%',
                }
              }
            ]
          }
        ],
        dataElementDelegates: {
          'testExtension.static': function(module, require) {
            module.exports = function(config) {
              return config.staticValue;
            };
          }
        },
        dataElements: [
          {
            name: "treat",
            type: "testExtension.static",
            config: {
              staticValue: "Ice   \n Cream  \n  ",
              forceLowerCase: true,
              cleanText: true
            }
          },
          {
            name: "vegetable",
            type: "testExtension.static",
            config: {
              staticValue: "carrot"
            }
          },
          {
            name: "meat",
            type: "testExtension.static",
            config: {
              default: "default meat"
            }
          },
          {
            name: 'bottlesofbeeronthewall',
            type: 'testExtension.static',
            config: {
              staticValue: 99,
              forceLowerCase: true
            }
          },
          {
            name: "beverage:pageview",
            type: "testExtension.static",
            config: {
              staticValue: 'Piña Colada',
              storeLength: 'pageview'
            }
          },
          {
            name: "beverage:visitor",
            type: "testExtension.static",
            config: {
              staticValue: 'Soda',
              storeLength: 'visitor'
            }
          },
          {
            name: "beverage:session",
            type: "testExtension.static",
            config: {
              staticValue: 'Fruit Punch',
              storeLength: 'session'
            }
          }
        ],
        config: {
          undefinedVarsReturnEmpty: true
        }
      };

      _satellite = {
        container: container
      };
    </script>
    <script src="/base/dist/engine.js"></script>
    <script src="/base/src/__tests__/helpers/testpage.js"></script>
    <script>
      TestPage
        .execute(function() {
          window.my = {
            nested: {
              thing: 'applejacks'
            }
          };

          _satellite.setVar('instrument', 'piccolo');
          _satellite.setVar('vegetable', 'onion');

          expect(coreDelegateSpy.calls.argsFor(0)[0].integrationConfigs).toEqual([
            {
              mmmtreats: 'ice cream',
              accountId: 123
            }
          ]);

          _satellite.triggerTestEvent();

          // Actions are always run asynchronously.
          jasmine.clock().tick(1);

          expect(actionDelegateSpy.calls.count()).toBe(1);
          var actionConfig = actionDelegateSpy.calls.argsFor(0)[0].actionConfig;
          expect(actionConfig.dataElementBased).toBe('ice cream');
          // Both a data element and a custom variable (set using setVar) named "vegetable" have
          // been set. The data element has a higher priority.
          expect(actionConfig.dataElementPriorityBased).toBe('carrot');
          expect(actionConfig.dataElementDefaultBased).toBe('default meat');
          expect(actionConfig.dataElementIntegerBased).toBe('99');
          expect(actionConfig.dataElementPageViewBased).toBe('Piña Colada');
          expect(document.cookie.indexOf('_sdsat_beverage:pageview=Piña Colada')).toBe(-1);
          expect(actionConfig.dataElementVisitorBased).toBe('Soda');
          expect(document.cookie.indexOf('_sdsat_beverage:visitor=Soda') > -1).toBe(true);
          expect(actionConfig.dataElementSessionBased).toBe('Fruit Punch');
          expect(document.cookie.indexOf('_sdsat_beverage:session=Fruit Punch') > -1).toBe(true);
          expect(actionConfig.URIBased).toBe(document.location.pathname + document.location.search);
          expect(actionConfig.uriBased).toBe(document.location.pathname + document.location.search);
          expect(actionConfig.protocolBased).toBe(window.location.protocol);
          expect(actionConfig.hostnameBased).toBe(document.location.hostname);
          expect(actionConfig.thisBased).toBe('kazoo');
          expect(actionConfig.thisTextBased).toBe('  Content with line \n breaks and multiple   spaces');
          expect(actionConfig.thisCleanTextBased).toBe('Content with line breaks and multiple spaces');
          expect(actionConfig.eventBased).toBe('apple');
          expect(actionConfig.targetBased).toBe('fruitPartyBowl');
          expect(actionConfig.windowBased).toBe('applejacks');
          expect(actionConfig.paramBased).toBe('barValue');
          expect(typeof actionConfig.randBased).toBe('string');
          expect(actionConfig.randBased.length).toBe(3);
          expect(actionConfig.customBased).toBe('piccolo');
          // undefinedVarsReturnEmpty=true on property config so it returns an empty string
          expect(actionConfig.undefinedBased).toBe('');
          expect(_satellite.getVar('instrument')).toBe('piccolo');
          expect(_satellite.getVar('bottlesofbeeronthewall')).toBe(99);
          // Note that even though "onion" was set through setVar() the configured data element
          // still takes precedence.
          expect(_satellite.getVar('vegetable')).toBe('carrot');
          // When undefinedVarsReturnEmpty is true on property config, getVar() still returns
          // undefined. It only returns an empty string when using a %% token for some reason.
          expect(_satellite.getVar('undefinedBased')).toBe(undefined);
        })
        .start();
    </script>
  </head>
  <body>
    <script>
      _satellite.pageBottom();
    </script>
  </body>
</html>
