<html>
<head>
  <script src="/base/dist/config.js"></script>
  <script src="../eventEngineConfig.js"></script>
  <script>
    var currentTarget;
    var actionSpy = jasmine.createSpy();

    var conditionSpy = jasmine.createSpy().and.callFake(function(eventDetail) {
      // Current target must be captured here instead of inspecting the spy call because
      // currentTarget will change over time.
      currentTarget = eventDetail.currentTarget;
      return true;
    });

    jasmine.clock().install();

    var ruleEvents = [
      {
        type: 'dtm.click',
        settings: {
          selector: '.test',
          eventHandlerOnElement: true
        }
      },
      {
        type: 'dtm.mouseover',
        settings: {
          selector: '.test',
          eventHandlerOnElement: true
        }
      }
    ];

    initEventEngineConfig(ruleEvents, actionSpy, conditionSpy);
  </script>
  <script src="/base/dist/engine.js"></script>
  <script src="/base/src/__tests__/testpage.js"></script>
  <script src="/base/node_modules/simulate/simulate.js"></script>
</head>
<body>
  <div id="testContainer" class="test">Test</div>
  <script>
    _satellite.pageBottom();
  </script>
  <script>
    var testContainer = document.getElementById('testContainer');

    function testEventType(eventType) {
      Simulate[eventType](testContainer);
      // Actions are always run asynchronously.
      jasmine.clock().tick(1);
      expect(actionSpy.calls.count()).toEqual(1);
      expect(conditionSpy.calls.count()).toEqual(1);
      expect(conditionSpy.calls.argsFor(0)[0].type).toEqual(eventType);
      expect(currentTarget).toBe(testContainer);
      actionSpy.calls.reset();
      conditionSpy.calls.reset();
    }

    TestPage
      .execute(function() {
        // When adding the event handler directly to the element, the global poller has to first
        // detect that the element has been added to the DOM before the event listener is added.
        jasmine.clock().tick(10000);
        ['click', 'mouseover'].forEach(testEventType);
      })
      .start();
  </script>
</body>
</html>
