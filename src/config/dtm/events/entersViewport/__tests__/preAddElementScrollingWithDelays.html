<html>
  <head>
    <script src="/base/dist/config.js"></script>
    <script src="../../__tests__/helpers/configureEngineForEventTests.js"></script>
    <script src="/base/src/__tests__/helpers/testpage.js"></script>
    <script>
      var rule1Events = [
        {
          type: 'dtm.entersViewport',
          config: {
            selector: '.testA'
          }
        },
        {
          type: 'dtm.entersViewport',
          config: {
            selector: '.testB',
            delay: 5000
          }
        }
      ];

      var rule2Events = [
        {
          type: 'dtm.entersViewport',
          config: {
            selector: '.testB',
            delay: 30000
          }
        }
      ];

      var actionSpy = jasmine.createSpy();

      configureActionForEventTests(actionSpy);
      configureRuleForEventTests(rule1Events);
      configureRuleForEventTests(rule2Events);

      jasmine.clock().install();

      TestPage
        .waitForContentLoaded()
        .execute(function() {
          // Give time for the poller to cycle.
          jasmine.clock().tick(10000);
          expect(actionSpy.calls.count()).toEqual(0);

          window.scrollTo(0, 10000);

          // Give time for the poller to cycle.
          jasmine.clock().tick(10000);
          expect(actionSpy.calls.count()).toEqual(1);

          window.scrollTo(0, 0);

          // Give time for the poller to cycle.
          jasmine.clock().tick(10000);

          window.scrollTo(0, 10000);

          // Give time for the poller to cycle.
          jasmine.clock().tick(10000);
          // The rule should only fire the first time the element comes into view.
          expect(actionSpy.calls.count()).toEqual(1);

          window.scrollTo(0, 20000);

          // Give time for the poller to cycle but not enough time for the configured delay
          // time to pass. The rule shouldn't be triggered because the configured delay time
          // hasn't passed.
          jasmine.clock().tick(4000);
          expect(actionSpy.calls.count()).toEqual(1);

          window.scrollTo(0, 0);

          // Give time for the poller to cycle and enough time for the configured delay time to
          // pass. The rule shouldn't be triggered because it's no longer in view.
          jasmine.clock().tick(10000);
          expect(actionSpy.calls.count()).toEqual(1);

          window.scrollTo(0, 20000);

          // Give time for the poller to cycle and enough time for the configured delay time to
          // pass. The rule should be triggered.
          jasmine.clock().tick(10000);
          expect(actionSpy.calls.count()).toEqual(2);

          // A different rule watching for the same element but an even longer delay time? Oh my!
          jasmine.clock().tick(100000);
          expect(actionSpy.calls.count()).toEqual(3);
        })
        .start();
    </script>
    <script src="/base/dist/engine.js"></script>

    <style type="text/css">
      .testA {
        position: absolute;
        top: 10000px;
      }

      .testB {
        position: absolute;
        top: 20000px;
      }
    </style>
  </head>
  <body>
    <div class="testA">Test</div>
    <div class="testB">Test</div>
    <script>
      _satellite.pageBottom();
    </script>
  </body>
</html>
