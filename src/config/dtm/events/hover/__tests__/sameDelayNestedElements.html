<html>
  <head>
    <script src="/base/dist/config.js"></script>
    <script src="../../__tests__/helpers/configureEngineForEventTests.js"></script>
    <script>
      jasmine.clock().install();

      var aConditionSpy = jasmine.createSpy().and.returnValue(true);
      configureRuleForEventTests([
        {
          type: 'dtm.hover',
          config: {
            selector: '#a',
            bubbleFireIfParent: true,
            bubbleFireIfChildFired: true,
            bubbleStop: false,
            delay: 1000
          }
        }
      ], aConditionSpy);

      var bConditionSpy = jasmine.createSpy().and.returnValue(true);
      configureRuleForEventTests([
        {
          type: 'dtm.hover',
          config: {
            selector: '#b',
            bubbleFireIfParent: true,
            bubbleFireIfChildFired: true,
            bubbleStop: false,
            delay: 1000
          }
        }
      ], bConditionSpy);
    </script>
    <script src="/base/dist/engine.js"></script>
    <script src="/base/src/__tests__/helpers/testpage.js"></script>
    <script src="/base/node_modules/simulate/simulate.js"></script>
    <script>
      TestPage
        .waitForContentLoaded()
        .execute(function() {
          // Give the poller time to pick up on the target elements.
          jasmine.clock().tick(10000);

          Simulate.mouseenter(document.getElementById('a'));
          Simulate.mouseenter(document.getElementById('b'));

          jasmine.clock().tick(800);

          Simulate.mouseleave(document.getElementById('a'));
          Simulate.mouseleave(document.getElementById('b'));

          expect(aConditionSpy.calls.count()).toEqual(0);
          expect(bConditionSpy.calls.count()).toEqual(0);

          Simulate.mouseenter(document.getElementById('a'));
          Simulate.mouseenter(document.getElementById('b'));

          jasmine.clock().tick(1200);

          // Because the rules are on the same delay, the hover event from element B also executes
          // rule A when it "bubbles up".
          expect(aConditionSpy.calls.count()).toEqual(2);
          expect(aConditionSpy.calls.first()).toEqual({
            object: a,
            args: [{type: 'hover(1000)', target: a}, a],
            returnValue: true
          });
          expect(aConditionSpy.calls.mostRecent()).toEqual({
            object: a,
            args: [{type: 'hover(1000)', target: b}, b],
            returnValue: true
          });
          expect(bConditionSpy.calls.count()).toEqual(1);
          expect(bConditionSpy.calls.mostRecent()).toEqual({
            object: b,
            args: [{type: 'hover(1000)', target: b}, b],
            returnValue: true
          });
        })
        .start();
    </script>
  </head>
  <body>
    <div id="a">
      A
      <div id="b">
        B
      </div>
    </div>

    <script>
      _satellite.pageBottom();
    </script>
  </body>
</html>
